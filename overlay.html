<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>MSFS Overlay</title>
    <style>
      :root {
        --primary: #ffffff;
        --secondary: #999999;
        --text: #ffffff;
      }
      body {
        margin: 0;
        background: transparent;
        font-family: Arial, sans-serif;
        color: var(--text);
      }
      .box {
        display: inline-block;
        padding: 14px 16px;
        background: rgba(0, 0, 0, 0.55);
        border: 2px solid rgba(255, 255, 255, 0.12);
        border-radius: 12px;
        font-size: 20px;
        line-height: 1.35;
        min-width: 360px;
      }
      .top {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
      }
      .logo {
        width: 34px;
        height: 34px;
        object-fit: contain;
        display: none;
        filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.35));
      }
      .titleline {
        font-size: 18px;
        opacity: 0.9;
      }
      .accent {
        color: var(--primary);
        font-weight: 700;
      }
      .row {
        display: flex;
        justify-content: space-between;
        gap: 18px;
        white-space: nowrap;
      }
      .label {
        opacity: 0.75;
      }
      .value {
        font-weight: 650;
      }
      .sep {
        height: 10px;
      }
      .muted {
        opacity: 0.75;
        font-size: 14px;
        margin-top: 8px;
      }
      .warn {
        color: #ffd37a;
      }
    </style>
  </head>
  <body>
    <div class="box">
      <div class="top">
        <img id="logo" class="logo" alt="logo" />
        <div class="titleline">
          <span class="accent" id="callsign">--</span>
          <span id="aircraft">--</span>
          <span id="route">---</span>
        </div>
      </div>

      <div class="row">
        <span class="label">IAS</span><span class="value"><span id="ias">--</span> kt</span>
      </div>
      <div class="row">
        <span class="label">ALT</span><span class="value"><span id="alt">--</span> ft</span>
      </div>
      <div class="row">
        <span class="label">VS</span><span class="value"><span id="vs">--</span> fpm</span>
      </div>
      <div class="row">
        <span class="label">HDG</span><span class="value"><span id="hdg">--</span>°</span>
      </div>
      <div class="row">
        <span class="label">GS</span><span class="value"><span id="gs">--</span> kt</span>
      </div>

      <div class="sep"></div>

      <div class="row">
        <span class="label">OAT</span><span class="value"><span id="oat">--</span> °C</span>
      </div>
      <div class="row">
        <span class="label">TAT</span><span class="value"><span id="tat">--</span> °C</span>
      </div>
      <div class="row">
        <span class="label">WIND</span><span class="value"><span id="wind">--</span></span>
      </div>

      <div class="sep"></div>

      <div class="row">
        <span class="label">DTG</span><span class="value"><span id="dtg">--</span> nm</span>
      </div>
      <div class="row">
        <span class="label">ETE</span><span class="value"><span id="ete">--</span></span>
      </div>
      <div class="row">
        <span class="label">ETA</span><span class="value"><span id="eta">--</span></span>
      </div>

      <div class="muted" id="status"></div>
    </div>

    <script>
      const el = (id) => document.getElementById(id);

      function fmt(n, digits = 0) {
        if (n === null || n === undefined || Number.isNaN(n)) return "--";
        return Number(n).toFixed(digits);
      }
      function safeStr(v, fallback = "--") {
        if (v === null || v === undefined) return fallback;
        const s = String(v).trim();
        return s.length ? s : fallback;
      }
      function fmtWind(dir, spd) {
        if (dir == null || spd == null) return "--";
        return `${Math.round(Number(dir))}° / ${Math.round(Number(spd))} kt`;
      }

      async function loadTheme() {
        try {
          const r = await fetch("/theme", { cache: "no-store" });
          const t = await r.json();

          const theme = t.theme || {};
          const colors = theme.colors || {};
          document.documentElement.style.setProperty("--primary", colors.primary || "#ffffff");
          document.documentElement.style.setProperty("--secondary", colors.secondary || "#999999");
          document.documentElement.style.setProperty("--text", colors.text || "#ffffff");

          const logoUrl = t.logo_url;
          const logo = el("logo");
          if (logoUrl) {
            logo.src = logoUrl;
            logo.style.display = "block";
          } else {
            logo.style.display = "none";
          }
        } catch (e) {
          // theme is optional; ignore failures
        }
      }

      async function tick() {
        try {
          const r = await fetch("/data", { cache: "no-store" });
          const d = await r.json();

          // SimBrief fields
          const sb = d.simbrief || {};
          const cs = safeStr(sb.callsign, "--");
          const dep = safeStr(sb.dep_icao, "---");
          const arr = safeStr(sb.arr_icao, "---");

          el("callsign").textContent = cs;

          // Aircraft ICAO (from SimConnect)
          const ac = safeStr(d.aircraft_icao, "");
          el("aircraft").textContent = ac ? `· ${ac}` : "";

          // DEP/ARR
          el("route").textContent =
            dep && arr && dep !== "---" && arr !== "---" ? `· ${dep} → ${arr}` : "";

          // Live fields
          el("ias").textContent = fmt(d.ias_kt, 0);
          el("alt").textContent = fmt(d.alt_ft, 0);
          el("vs").textContent = fmt(d.vs_fpm, 0);
          el("hdg").textContent = d.hdg_act == null ? "--" : fmt(d.hdg_act, 0);
          el("gs").textContent = fmt(d.gs_kt, 0);

          el("oat").textContent = d.oat_c == null ? "--" : fmt(d.oat_c, 0);
          el("tat").textContent = d.tat_c == null ? "--" : fmt(d.tat_c, 0);
          el("wind").textContent = fmtWind(d.wind_dir_true, d.wind_spd_kt);

          // Destination-based DTG/ETE/ETA (computed in backend)
          el("dtg").textContent = d.dtg_nm == null ? "--" : fmt(d.dtg_nm, 1);
          el("ete").textContent = safeStr(d.ete_hhmm, "--");
          el("eta").textContent = safeStr(d.eta_z, "--");

          // Status line
          let status = "";
          if (!d.simconnect_ok) {
            status = `Sim not running / SimConnect not available`;
            el("status").classList.add("warn");
          } else {
            el("status").classList.remove("warn");
            if (!d.simbrief_ok) status = safeStr(d.simbrief_error, "SimBrief not available");
          }
          el("status").textContent = status;
        } catch (e) {
          // keep overlay stable
        }
      }

      // initial theme + periodic refresh (in case the flight changes)
      loadTheme();
      setInterval(loadTheme, 15000);

      // poll sim data every 1000ms
      tick();
      setInterval(tick, 1000);
    </script>
  </body>
</html>
